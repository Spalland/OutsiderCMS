/*! outsider 2017-05-30 */
angular.module("adminArticleCtrl",["ui.tinymce"]).controller("adminArticleController",["Article","Category","Activity","Auth","$location","action","$routeParams","Modal","Image","$http","toasty","$filter",function(Article,Category,Activity,Auth,$location,action,$routeParams,Modal,Image,$http,toasty,$filter){var ctrl=this;switch(ctrl.error=[],ctrl.opened=!1,ctrl.filters={},ctrl.filters.published=!0,ctrl.action=action,ctrl.saveMessage="Save Changes",ctrl.dateFormat="dd/MM/yyyy",ctrl.tinymceOptions={plugins:"link",toolbar:"undo redo | styleselect | bold italic underline strikethrough | alignleft aligncenter alignright | link",content_css:"/dist/css/tinystyles.min.css",menubar:!1},ctrl.userRole=Auth.getUser().role,ctrl.slugIsReserved=!1,ctrl.reservedSlug="",ctrl.open=function(){0==ctrl.opened?ctrl.opened=!0:ctrl.opened=!1},ctrl.genslug=function(callback){if(1!=ctrl.slugIsReserved){var slug="";""==ctrl.article.slug||void 0==ctrl.article.slug?""==ctrl.article.title||void 0==ctrl.article.title?(ctrl.article.title="Untitled Draft",slug=Math.random().toString(36).substring(7)):slug=ctrl.article.title.toLowerCase().replace(/ /g,"-").replace(/[^\w-]+/g,""):slug=ctrl.article.slug.toLowerCase().replace(/ /g,"-").replace(/[^\w-]+/g,""),Article.reserveSlug(slug).then(function(response){ctrl.article.slug=response.data.data,ctrl.reservedSlug=response.data.data,ctrl.slugIsReserved=!0,void 0!==callback&&callback()})}},ctrl.unReserve=function(){ctrl.slugIsReserved=!1},ctrl.stillReserved=function(){ctrl.article.slug==ctrl.reservedSlug&&(ctrl.slugIsReserved=!0)},ctrl.hasError=function(field){for(var l=0;l<ctrl.error.length;l++)if(ctrl.error[l].field===field)return"validation-error";return""},ctrl.canModify=function(){var status=ctrl.article.status;return"Draft"===status||(!("Submitted"!==status||!Auth.hasRole("Editor")&&!Auth.hasRole("Reviewer"))||!!Auth.hasRole("Editor"))},ctrl.workflowMessage=function(){var status=ctrl.article.status;switch(status){case"Draft":return"Write something awesome then submit when you are done! Don't forget save";case"Submitted":return"Your article has been submitted for approval, you will be notified when a decision has been made";case"Approved":return"Congratulations! Your article is waiting to be scheduled for publishing";case"Rejected":return"Unfortunately your article has been deemed unsuitable for Outsider.guide. This will be deleted automatically soon";case"Deleted":return"Your article is in the bin....did you mean to do this? Click below to retreive it";case"Published":if(ctrl.article.publish_date){var date;console.log();var pd=ctrl.article.publish_date,t=pd.split("T"),d=t[0]+"T"+t[1].substring(t[1].length,-1),d1=new Date(d),d2=new Date;date=+d1>+d2?"Your article will be published on "+$filter("date")(pd,"dd/MM/yy")+" @ "+$filter("date")(pd,"hh:mm")+". Exciting Times!":"This article is already published and being read by the world"}else date="Your article has been published it will appear on the site soon";return date;default:return"Something wen't wrong"}},ctrl.setStatus=function(status){switch(status){case"Submitted":Article.update(ctrl.article.id,{status:"Submitted"}).then(function(response){var data=response.data;data.success===!0?(ctrl.article.status=data.data.status,toasty.success({title:"Submit Successful",msg:"You have successfully submitted your article for approval"})):toasty.error({title:"Submit Failed",msg:data.error})});break;case"Rejected":Article.update(ctrl.article.id,{status:"Rejected"}).then(function(response){var data=response.data;data.success===!0?(ctrl.article.status=data.data.status,toasty.success({title:"Reject Succesful",msg:"You have successfully rejected this article"})):toasty.error({title:"Reject Failed",msg:data.error})});break;case"Approved":Article.update(ctrl.article.id,{status:"Approved"}).then(function(response){var data=response.data;data.success===!0?(ctrl.article.status=data.data.status,toasty.success({title:"Approval Succesful",msg:"You have successfully approved this article"})):toasty.error({title:"Approval Failed",msg:data.error})});break;case"Published":var publish_date;if(publish_date=ctrl.article.publish_date?ctrl.article.publish_date:new Date,!ctrl.article.image_id){toasty.error({title:"Main article image error",msg:"You must supply an image to publish an article"});break}ctrl.article.status="Published",ctrl.article.publisher_id=Auth.getUser().id,ctrl.article.publish_date=publish_date,Article.update(ctrl.article.id,ctrl.article).then(function(response){var data=response.data;if(data.success===!0){var date,t=data.data.publish_date.split("T"),d=t[0]+"T"+t[1].substring(t[1].length,-1),d1=new Date(d),d2=new Date;date=+d1>+d2?$filter("date")(data.data.publish_date,"dd/MM/yy")+" @ "+$filter("date")(data.data.publish_date,"hh:mm"):"now",toasty.success({title:"Publish Succesful",msg:"You have successfully published this article it will be visible from "+date}),ctrl.workflowMessage()}else toasty.error({title:"Approval Failed",msg:data.error})})}},ctrl.deleteArticle=function(id){Article["delete"](id)},ctrl.imageModal=function(model,requiredCrop){Modal.showModal({templateUrl:"views/partials/imageModal.html",controller:"imageController",controllerAs:"image",inputs:{requiredCrop:requiredCrop}}).then(function(modal){modal.close.then(function(result){result&&(ctrl.article[model]=result.id,Image.getCrop(result.id).then(function(response){ctrl.currentImage=response.data.data.filename}))})})},ctrl.verifyVideo=function(){ctrl.error=[];var url=ctrl.article.video;url.match("http(s)://(www.)?youtube|youtu.be")?(url.match("embed")?youtube_id=url.split(/embed\//)[1].split('"')[0]:youtube_id=url.split(/v\/|v=|youtu\.be\//)[1].split(/[?&]/)[0],$http.get("https://www.googleapis.com/youtube/v3/videos?part=id&id="+youtube_id+"&key=AIzaSyAyOpvqABdaK08wf939RMHhMTBpKJSZ36s").then(function(res){1==res.data.pageInfo.totalResults?(ctrl.article.video=youtube_id,ctrl.inputDisabled=!0):(ctrl.error.push({field:"video",message:"Video could not be found on youtube"}),toasty.error({title:"Video Selection Error",msg:"Video could not be found on youtube"}))})):(ctrl.article.video=void 0,ctrl.inputDisabled=!1,ctrl.error.push({field:"video",message:"Invalid link supplied, Please supply a full YouTube link"}),toasty.error({title:"Video Selection Error",msg:"Invalid link supplied, Please supply a <strong>full</strong> YouTube link"}))},ctrl.clearVideo=function(){ctrl.inputDisabled=!1,ctrl.article.video=void 0},ctrl.initIndex=function(){ctrl.article={},ctrl.article.slug="",ctrl.initCategories(),ctrl.initActivities(),Article.all().then(function(response){console.log(response),ctrl.articles=response.data.data})},ctrl.initCreate=function(){ctrl.article={},ctrl.article.status="Draft",ctrl.article.slug="",ctrl.initCategories(),ctrl.initActivities()},ctrl.initEdit=function(){ctrl.article={},ctrl.initCategories(),ctrl.initActivities();var id=$routeParams.id;Article.get(id).then(function(response){ctrl.article=response.data.data;var slug=ctrl.article.slug;null==slug&&void 0==slug&&""==slug||(ctrl.slugIsReserved=!0),ctrl.article.video&&(ctrl.inputDisabled=!0),ctrl.article.image_id&&Image.getCrop(ctrl.article.image_id).then(function(response){ctrl.currentImage=response.data.data.filename})})},ctrl.initCategories=function(){Category.all().then(function(response){ctrl.categories=response.data.data,ctrl.article.category=ctrl.categories[0].id})},ctrl.initActivities=function(){Activity.all().then(function(response){ctrl.activities=response.data.data,ctrl.article.activity=ctrl.activities[0].id})},ctrl.createArticle=function(){Article.create(ctrl.article).then(function(response){var data=response.data;data.success?(toasty.success({title:"Article Saved",msg:"Your article is now saved",sticky:!0}),$location.path("/admin/articles/edit/"+data.data.id)):(console.log(response),toasty.error({title:"Article Save Failed",msg:data.error}))})},ctrl.updateArticle=function(){Article.update(ctrl.article.id,ctrl.article).then(function(response){var data=response.data;data.success?(toasty.success({title:"Article Saved",msg:"Your article is now saved",sticky:!0}),ctrl.article.updatedAt=data.data.updatedAt):toasty.error({title:"Article Save Failed",msg:data.error})})},ctrl.submitArticle=function(){"create"==action?1==ctrl.slugIsReserved?ctrl.createArticle():ctrl.genslug(ctrl.createArticle):"edit"==action&&(1==ctrl.slugIsReserved?ctrl.updateArticle():ctrl.genslug(ctrl.updateArticle))},ctrl.hidePublished=function(story){return!!ctrl.filters.published||null==story.publish_date},ctrl.change=function(){},action){case"index":ctrl.initIndex();break;case"create":ctrl.initCreate();break;case"edit":ctrl.initEdit()}}]);