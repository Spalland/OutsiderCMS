/*! outsider 2017-05-30 */
angular.module("imageCropper",[]).directive("imgManipulator",[function($compile){return{restrict:"E",templateUrl:"views/partials/image-cropper.html",scope:{aspectRatio:"=?",offsetX:"=?",offsetY:"=?",cropWidth:"=?",cropHeight:"=?",imgSrc:"=",unsavedChanges:"=?"},transclude:!1,controller:["$scope","$window","$timeout",function($scope,$window,$timeout){function onResizeStart(e,mode,resizeFunction){e.preventDefault(),e.stopPropagation(),initialResizeX=e.pageX,initialResizeY=e.pageY,isResizing=!0,currentMode=mode,currentResizingFunc=resizeFunction}function onResize(e){e.preventDefault(),e.stopPropagation(),currentResizeX=e.pageX,currentResizeY=e.pageY,currentResizingFunc(initialResizeX-currentResizeX,initialResizeY-currentResizeY,currentMode),initialResizeX=currentResizeX,initialResizeY=currentResizeY,drawRectangle()}function onResizeStop(){isResizing=!1}function onMoveStart(e){e.preventDefault(),e.stopPropagation(),isMoving=!0,initialMoveX=e.pageX,initialMoveY=e.pageY}function onMove(e){currentMoveX=e.pageX,currentMoveY=e.pageY,move(initialMoveX-currentMoveX,initialMoveY-currentMoveY),initialMoveX=currentMoveX,initialMoveY=currentMoveY,drawRectangle()}function resetInteractions(){isMoving=!1,isCreating=!1}function calculateRectangleDimensions(mouseX,mouseY,oldMouseX,oldMouseY){var tempHolder,width,height;mouseX<oldMouseX&&(tempHolder=mouseX,mouseX=oldMouseX,oldMouseX=tempHolder),mouseY<oldMouseY&&(tempHolder=mouseY,mouseY=oldMouseY,oldMouseY=tempHolder),width=mouseX-oldMouseX,$scope.aspectRatio&&width*$scope.aspectRatio+oldMouseY>img.offsetHeight&&(width=(img.offsetHeight-oldMouseY)/$scope.aspectRatio),height=$scope.aspectRatio?width*$scope.aspectRatio:mouseY-oldMouseY,oldMouseY+=dragCorrectionY,oldMouseX+=dragCorrectionX,oldMouseX+width>img.offsetWidth&&(oldMouseX=img.offsetWidth-width),oldMouseY+height>img.offsetHeight&&(oldMouseY=img.offsetHeight-height),oldMouseX<0&&(oldMouseX=0,dragCorrectionX=0),oldMouseY<0&&(oldMouseY=0,dragCorrectionY=0),cbLeft=oldMouseX,cbTop=oldMouseY,cbWidth=width,cbHeight=height}function resetRect(){imageWidth=img.offsetWidth,imageHeight=img.offsetHeight,cbWidth=.8*imageWidth,cbHeight=$scope.aspectRatio?cbWidth*$scope.aspectRatio:.8*cbWidth,cbTop=(imageHeight-cbHeight)/2,cbLeft=(imageWidth-cbWidth)/2,drawRectangle()}function drawRectangle(){cb.style.backgroundPosition="-"+(cbLeft+1)+"px -"+(cbTop+1)+"px",cb.style.backgroundSize=img.offsetWidth+"px",cb.style.backgroundRepeat="no-repeat",cb.style.left=cbLeft+"px",cb.style.top=cbTop+"px",cb.style.width=cbWidth+"px",cb.style.height=cbHeight+"px",$timeout(function(){$scope.offsetX=cb.offsetLeft/img.offsetWidth*100,$scope.offsetY=cb.offsetTop/img.offsetHeight*100,$scope.cropWidth=cb.offsetWidth/img.offsetWidth*100,$scope.cropHeight=cb.offsetHeight/img.offsetHeight*100,$scope.unsavedChanges=!0})}var cbHeight,cbWidth,cbLeft,cbTop,imageWidth,imageHeight,offset,initialResizeX,initialResizeY,currentResizeX,currentResizeY,initialCreateX,initialCreateY,currentCreateX,currentCreateY,initialMoveX,initialMoveY,currentMoveX,currentMoveY,currentMode,cb=$window.document.getElementById("crop-box"),img=$window.document.getElementById("img-viewer-img"),fade=$window.document.getElementById("img-viewer-fade"),isCreating=!1,isMoving=!1,isResizing=!1,scrollLeft=($window.pageXOffset||$window.document.scrollLeft)-($window.document.clientLeft||0),scrollTop=($window.pageYOffset||$window.document.scrollTop)-($window.document.clientTop||0),horizontalScaling=function(xDelta,yDelta,mode){0===mode?(cbWidth+=xDelta,cbLeft-=xDelta):cbWidth-=xDelta,cbWidth<0&&(cbWidth=0),cbLeft<0&&(cbLeft=0),cbWidth+cbLeft>img.offsetWidth&&(cbWidth=img.offsetWidth-cbLeft),$scope.aspectRatio&&(cbWidth*$scope.aspectRatio+cbTop>img.offsetHeight&&(cbWidth=(img.offsetHeight-cbTop)/$scope.aspectRatio),cbHeight=cbWidth*$scope.aspectRatio)},verticalScaling=function(xDelta,yDelta,mode){0===mode?(cbHeight+=yDelta,cbTop-=yDelta):cbHeight-=yDelta,cbHeight<0&&(cbHeight=0),cbTop<0&&(cbTop=0),cbHeight+cbTop>img.offsetHeight&&(cbHeight=img.offsetHeight-cbTop),$scope.aspectRatio&&(cbHeight*$scope.aspectRatio+cbLeft>img.offsetWidth&&(cbHeight=(img.offsetHeight-cbLeft)/(1/$scope.aspectRatio)),cbWidth+cbLeft>img.offsetWidth?(cbWidth=img.offsetWidth-cbLeft,cbHeight=cbWidth*$scope.aspectRatio):cbWidth=cbHeight*(1/$scope.aspectRatio))},diagonalScaling=function(xDelta,yDelta,mode){0===mode?(horizontalScaling(xDelta,yDelta,0),verticalScaling(xDelta,yDelta,0)):1===mode?(verticalScaling(xDelta,yDelta,0),$scope.aspectRatio||horizontalScaling(xDelta,yDelta,1)):2===mode?(verticalScaling(xDelta,yDelta,1),$scope.aspectRatio||horizontalScaling(xDelta,yDelta,1)):3===mode&&(horizontalScaling(xDelta,yDelta,0),$scope.aspectRatio||verticalScaling(xDelta,yDelta,1)),drawRectangle()},move=function(xDelta,yDelta){cbLeft-xDelta>0&&cbLeft-xDelta+cbWidth<img.offsetWidth?cbLeft-=xDelta:cbLeft-xDelta<0?cbLeft=0:cbLeft-xDelta+cbWidth>img.offsetWidth&&(cbLeft=img.offsetWidth-cbWidth),cbTop-yDelta>0&&cbTop-yDelta+cbHeight<img.offsetHeight?cbTop-=yDelta:cbTop-yDelta<0?cbTop=0:cbTop-yDelta+cbHeight>img.offsetHeight&&(cbTop=img.offsetHeight-cbHeight)},onMouseUpFunction=function(e){initialMoveX=0,initialMoveY=0,e.preventDefault(),resetInteractions(),isResizing&&onResizeStop()},calculateCurrentCreateX=function(e){currentCreateX=scrollLeft?e.pageX-offset.left-scrollLeft:e.pageX-offset.left},calculateCurrentCreateY=function(e){currentCreateY=scrollTop?e.pageY-offset.top-scrollTop:e.pageY-offset.top},calculateScroll=function(){scrollLeft=($window.pageXOffset||$window.document.scrollLeft)-($window.document.clientLeft||0),scrollTop=($window.pageYOffset||$window.document.scrollTop)-($window.document.clientTop||0)};$window.document.getElementById("handles-top-left").addEventListener("mousedown",function(e){onResizeStart(e,0,diagonalScaling)}),$window.document.getElementById("handles-top-right").addEventListener("mousedown",function(e){onResizeStart(e,1,diagonalScaling)}),$window.document.getElementById("handles-bottom-right").addEventListener("mousedown",function(e){onResizeStart(e,2,diagonalScaling)}),$window.document.getElementById("handles-bottom-left").addEventListener("mousedown",function(e){onResizeStart(e,3,diagonalScaling)}),$window.document.getElementById("handles-middle-left").addEventListener("mousedown",function(e){onResizeStart(e,0,horizontalScaling)}),$window.document.getElementById("bounds-left").addEventListener("mousedown",function(e){onResizeStart(e,0,horizontalScaling)}),$window.document.getElementById("handles-middle-right").addEventListener("mousedown",function(e){onResizeStart(e,1,horizontalScaling)}),$window.document.getElementById("bounds-right").addEventListener("mousedown",function(e){onResizeStart(e,1,horizontalScaling)}),$window.document.getElementById("handles-top-center").addEventListener("mousedown",function(e){onResizeStart(e,0,verticalScaling)}),$window.document.getElementById("bounds-top").addEventListener("mousedown",function(e){onResizeStart(e,0,verticalScaling)}),$window.document.getElementById("handles-bottom-center").addEventListener("mousedown",function(e){onResizeStart(e,1,verticalScaling)}),$window.document.getElementById("bounds-bottom").addEventListener("mousedown",function(e){onResizeStart(e,1,verticalScaling)}),fade.addEventListener("mousedown",function(e){e.preventDefault(),isCreating=!0,offset=this.getBoundingClientRect(),initialCreateX=scrollLeft?e.pageX-offset.left-scrollLeft:e.pageX-offset.left,initialCreateY=scrollTop?e.pageY-offset.top-scrollTop:e.pageY-offset.top}),fade.addEventListener("mousemove",function(e){isMoving&&onMove(e),isCreating&&(offset=this.getBoundingClientRect(),calculateCurrentCreateX(e),calculateCurrentCreateY(e),dragCorrectionX=0,dragCorrectionY=0,calculateRectangleDimensions(currentCreateX,currentCreateY,initialCreateX,initialCreateY),drawRectangle()),isResizing&&onResize(e)}),fade.addEventListener("mouseup",function(){resetInteractions()}),fade.addEventListener("mouseout",function(e){isCreating&&(offset=this.getBoundingClientRect(),calculateCurrentCreateX(e),currentCreateX>imageWidth?currentCreateX=img.offsetWidth:currentCreateX<0&&(currentCreateX=0),calculateCurrentCreateY(e),currentCreateY<0&&(currentCreateY=0),calculateRectangleDimensions(currentCreateX,currentCreateY,initialCreateX,initialCreateY),drawRectangle())}),img.onload=function(){resetRect()},angular.element($window).on("resize",resetRect),$scope.$on("$destroy",function(){angular.element($window).off("resize",resetRect)}),angular.element($window).on("scroll",calculateScroll),$scope.$on("$destroy",function(){angular.element($window).off("scroll",calculateScroll)}),angular.element($window).on("mouseup",onMouseUpFunction),$scope.$on("$destroy",function(){angular.element($window).off("scroll",onMouseUpFunction)}),cb.addEventListener("mousedown",function(e){onMoveStart(e)}),cb.addEventListener("mousemove",function(e){e.preventDefault(),isCreating&&(offset=fade.getBoundingClientRect(),calculateCurrentCreateX(e),calculateCurrentCreateY(e),calculateRectangleDimensions(currentCreateX,currentCreateY,initialCreateX,initialCreateY),drawRectangle()),isMoving&&onMove(e),isResizing&&onResize(e)}),cb.addEventListener("mouseup",function(e){initialMoveX=0,initialMoveY=0,e.preventDefault(),resetInteractions()}),$scope.$watch("aspectRatio",function(newValue,oldValue){horizontalScaling(0,0,0),drawRectangle()})}]}}]);